version: '3.3'

services:
  webserver:
    image: nginx:alpine
    container_name: webserver
    volumes:
      - ./main:/application
      - ./docker/webserver/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - ${NGINX_PORT}:80
    links:
      - phoenix
      - php-fpm
    depends_on:
      - php-fpm

  php-fpm:
    build: docker/php-fpm
    container_name: php-fpm
    working_dir: /application
    volumes:
      - ./main:/application
      - ./docker/php-fpm/php-ini-overrides.ini:/etc/php/7.3/fpm/conf.d/99-overrides.ini
    environment:
      - DB_PORT=${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - mysql
      - redis

  phoenix:
    build: docker/phoenix
    container_name: phoenix
    volumes:
      - ./phoenix:/application
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis

  redis:
    image: bitnami/redis:latest
    container_name: redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - ${REDIS_PORT}:6379

  queue:
    build: docker/queue
    container_name: queue
    volumes:
      - ./main:/application
    environment:
      - DB_PORT=${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis
      - mysql

  scheduler:
    build: docker/scheduler
    container_name: scheduler
    command: sh /usr/bin/entrypoint.sh
    restart: unless-stopped 
    volumes:
      - ./main:/application
      - ./docker/scheduler/entrypoint.sh:/usr/bin/entrypoint.sh
    environment:
      - DB_PORT=${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis
      - mysql

  mysql:
    image: mysql:latest
    container_name: mysql
    restart: unless-stopped
    command:
      - "--default-authentication-plugin=mysql_native_password"
    ports:
      - ${MYSQL_PORT}:3306
    environment:
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}