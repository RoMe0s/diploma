version: '3.1'

services:
  webserver:
    image: nginx:alpine
    container_name: webserver
    volumes:
      - ./main:/var/application
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - ${NGINX_PORT}:80
    links:
      - phoenix
    depends_on:
      - php-fpm

  php-fpm:
    build: docker/php-fpm
    container_name: php-fpm
    working_dir: /application
    volumes:
      - ./main:/application
      - ./docker/php-fpm/php-ini-overrides.ini:/etc/php/7.3/fpm/conf.d/99-overrides.ini
    environment:
      - DB_PORT:${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT:${REDIS_PORT}
      - REDIS_PASSWORD:${REDIS_PASSWORD}
    depends_on:
      - mysql
      - redis

  phoenix:
    build: docker/phoenix
    container_name: phoenix
    volumes:
      - ./phoenix:/application
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis

  redis:
    container_name: redis
    image: bitnami/redis:latest
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - ${REDIS_PORT}:6379

  queue:
    build: docker/queue
    container_name: queue
    working_dir: /application
    tty: true
    volumes:
      - ./main:/application
    environment:
      - DB_PORT:${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT:${REDIS_PORT}
      - REDIS_PASSWORD:${REDIS_PASSWORD}
    depends_on:
      - redis
      - mysql

  scheduler:
    image: phpdockerio/php73-cli:latest
    container_name: scheduler
    working_dir: /application
    command: sh /usr/bin/entrypoint.sh
    restart: unless-stopped
    tty: true
    volumes:
      - ./main:/application
      - ./docker/scheduler/entrypoint.sh:/usr/bin/entrypoint.sh
    environment:
      - DB_PORT:${MYSQL_PORT}
      - DB_USERNAME=${MYSQL_USER}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_PORT:${REDIS_PORT}
      - REDIS_PASSWORD:${REDIS_PASSWORD}
    depends_on:
      - redis
      - mysql

  mysql:
    image: mysql:latest
    container_name: mysql
    restart: unless-stopped
    tty: true
    ports:
      - ${MYSQL_PORT}:3306
    environment:
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}